# C++图像处理代码性能优化作业

## 简介

ImgProcOptim 是体系结构课程大作业，任务是优化 C++ 图像处理代码，提升运行速度。优化前代码为 `source/v0.cpp`，主要包括高斯模糊和幂次变换两个部分。

## 实现与测试结果

以下结果均没有打开编译器优化，`optim_` 前缀省略

|源文件|基于优化的版本|优化项|运行时间|相对上一版本加速比|相对 v0 加速比|注释|
|------|-------------|------|-------|------|--------|----|
|v0.cpp|-|-| 16610 ms | - | - ||
|v1.cpp|v0.cpp|将二维 vector 替换为一维数组| 9359 ms |1.77|1.77||
|v11.cpp|v1.cpp|修改 gaussian filter 算法，减少访存次数，提高访存连续性| 11322 ms |0.83|1.47|有个已知 bug，但由于性能问题直接写 v12 了，该代码仅供对比|
|v12.cpp|v1.cpp|再次尝试修改 gaussian filter 算法，减少访存次数，提高访存连续性| 8189 ms | 1.14 | 2.03 |单项加速比约为 1.95 |
|v13.cpp|v1.cpp|使用 uint_fast8_t 类型提升访存效率| 9352 ms | 1.00 | 1.77 ||
|v14.cpp|v1.cpp|使用 im2col 优化访存连续性| 15715 ms |0.60|1.06||
|v15.cpp|v1.cpp|使用 LUT 优化 POWER_LAW_LUT 表| 3759 ms |2.49|4.42|单项加速比约为 6.13 |
|v2.cpp|v1.cpp|整合 v12 和 v15 的优化| 2355 ms | 3.97 | 7.05 ||
|v3.cpp|v2.cpp|使用 AVX2 指令集优化| 1180 ms | 2.00 | 14.08 | 为了便于编写，uint8 被改为 uint16，增加一倍内存占用 |
|v31.cpp|v3.cpp|修改 AVX2 指令写法，降低一半内存占用| 1767 ms | 0.67 | 9.40 | |
|v4.cpp|v3.cpp|使用 OpenMP 并行化| 310 ms | 3.81 | 53.6 | 4 线程 |
|v41.cpp|v31.cpp|使用 OpenMP 并行化| 478 ms | 3.68 | 34.75 | 4 线程 |

编译器优化对比

|源文件|优化级别|运行时间|相对未开优化 v0 加速比|
|------|--------|-------|------|
|v0.cpp|O0| 16610 ms | - |
|v4.cpp|O0| 310 ms | 53.6 |
|v41.cpp|O0| 419 ms | 39.6 |
|v0.cpp|O1| 5841 ms | 2.84 |
|v4.cpp|O1| 185 ms | 89.78 |
|v41.cpp|O1| 79 ms | 210.3 |
|v0.cpp|O2|5825 ms|2.85|
|v4.cpp|O2| 172 ms | 96.57 |
|v41.cpp|O2| 77 ms | 215.71 |
|v0.cpp|O3|5783 ms|2.87|
|v4.cpp|O3| 204 ms |81.42|
|v41.cpp|O3| 81 ms | 205.06 |
|v0.cpp|Ofast|1968 ms |8.44|
|v4.cpp|Ofast|188 ms |88.35|
|v41.cpp|Ofast| 85 ms |195.41|

针对 v31 的注释：

1. v31 为了可读性放弃了部分手调优化，所以编译器优化后性能比 v3 好
2. 内存对齐并没有被利用上，高斯模糊算法多读取了 2 次内存，所以其实还有优化空间（但我不想写了

## 运行

需要保证具有以下环境：

`clang++、openmp、x86-64、avx2、C++17、SSE2`

建议在 Linux 上使用 `make run` 编译运行